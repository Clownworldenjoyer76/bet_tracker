<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NHL Picks</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="css/terminal.css">
</head>

<body class="top-picks-page">
<div class="container">

<h1>NHL Picks</h1>

<div id="nav-placeholder"></div>

<section class="controls">
<label>Date:</label>
<input id="p-date" type="date">
</section>

<div id="status" class="status"></div>
<div id="games" class="games"></div>

</div>

<script>
fetch("nav.html")
.then(r=>r.text())
.then(d=>document.getElementById("nav-placeholder").innerHTML=d);

const dateInput=document.getElementById("p-date");
dateInput.value=new Date().toLocaleDateString("en-CA");
dateInput.addEventListener("change",loadPage);

loadPage();

async function loadPage(){

const date=dateInput.value.replaceAll("-","_");

document.getElementById("status").textContent="Loading...";
document.getElementById("games").innerHTML="";

const selectFile=`win/hockey/04_select/${date}_NHL.csv`;
const predFile=`win/hockey/00_intake/predictions/hockey_${date}.csv`;
const bookFile=`win/hockey/00_intake/sportsbook/hockey_${date}.csv`;

try{

const selectRows=await fetchCSV(selectFile);
const predRows=await fetchCSV(predFile);
const bookRows=await fetchCSV(bookFile);

const predMap=buildGameMap(predRows);
const bookMap=buildGameMap(bookRows);

let merged=selectRows.map(sel=>{

const parts=sel.game_id.split("_");

const gameDate=parts.slice(0,3).join("_");
const homeTeam=parts.slice(3,-1).join(" ");
const awayTeam=parts.slice(-1)[0];

const key=gameDate+"|"+homeTeam+"|"+awayTeam;

const pred=predMap[key]||{};
const book=bookMap[key]||{};

return {...sel,...pred,...book};
});

/* SORT BY SPORTSBOOK GAME TIME */
merged.sort((a,b)=>{
return parseTime(a.game_time)-parseTime(b.game_time);
});

renderGames(merged);

document.getElementById("status").textContent=
merged.length+" picks found";

}catch{
document.getElementById("status").textContent=
"No data found.";
}
}

function parseTime(t){
if(!t) return 0;
const m=t.match(/(\d+):(\d+)\s*(AM|PM)/i);
if(!m) return 0;
let h=parseInt(m[1]);
const min=parseInt(m[2]);
const p=m[3].toUpperCase();
if(p==="PM" && h!==12) h+=12;
if(p==="AM" && h===12) h=0;
return h*60+min;
}

async function fetchCSV(path){
const r=await fetch(path);
if(!r.ok) return [];
const txt=await r.text();
return parseCSV(txt);
}

function parseCSV(text){
const lines=text.trim().split(/\r?\n/);
const headers=lines[0].split(",").map(h=>h.trim());

return lines.slice(1).map(line=>{
const values=line.split(",");
let obj={};
headers.forEach((h,i)=>obj[h]=values[i]??"");
return obj;
});
}

function buildGameMap(rows){
let map={};
rows.forEach(r=>{
const key=r.game_date+"|"+r.home_team+"|"+r.away_team;
map[key]=r;
});
return map;
}

function renderGames(rows){

const container=document.getElementById("games");
container.innerHTML="";

rows.forEach(r=>{

const edge=r.take_bet_edge_pct
? (parseFloat(r.take_bet_edge_pct)*100).toFixed(2)+"%"
: "-";

const card=document.createElement("div");
card.className="game-card";

card.innerHTML=`
<div class="game-time">${r.game_time||"-"}</div>
<div class="game-matchup">${r.away_team||"-"} @ ${r.home_team||"-"}</div>
<div class="game-league">Bet</div>

<div class="game-market">${r.take_bet||"-"}</div>
<div class="game-line">${r.take_team||"-"}</div>
<div class="game-odds">Odds: ${r.take_odds||"-"}</div>
<div class="game-edge">Edge: ${edge}</div>
<div class="game-value">Value: ${r.value||"-"}</div>

<div class="game-proj">
Proj: ${r.away_projected_goals||"-"} - ${r.home_projected_goals||"-"}
(Total: ${r.total_projected_goals||"-"})
</div>

<div class="game-book">
ML: ${r.away_dk_moneyline_american||"-"} / ${r.home_dk_moneyline_american||"-"}
<br>
Line: ${r.away_puck_line||"-"} (${r.away_dk_puck_line_american||"-"})
/ ${r.home_puck_line||"-"} (${r.home_dk_puck_line_american||"-"})
<br>
Total: ${r.total||"-"} (O ${r.dk_total_over_american||"-"} / U ${r.dk_total_under_american||"-"})
</div>
`;

container.appendChild(card);
});
}
</script>
</body>
</html>
