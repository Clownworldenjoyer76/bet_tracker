<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Picks (Sortable)</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="css/terminal.css" />
</head>
<body class="top-picks-page">
  <div class="container">

    <h1>Picks (Sortable by League)</h1>

    <div id="nav-placeholder"></div>

    <section class="controls">
      <label for="p-date" class="control-label">Date:</label>
      <input id="p-date" type="date" />

      <label for="league-filter" class="control-label" style="margin-left:20px;">League:</label>
      <select id="league-filter">
        <option value="NHL">NHL</option>
        <option value="NBA">NBA</option>
        <option value="NCAAB">NCAAB</option>
      </select>
    </section>

    <div id="status" class="status"></div>
    <div id="games" class="games"></div>

  </div>

  <script src="app.js"></script>

  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });

    const dateInput = document.getElementById("p-date");
    const leagueSelect = document.getElementById("league-filter");

    const now = new Date();
    dateInput.value = now.toLocaleDateString("en-CA");

    dateInput.addEventListener("change", loadPage);
    leagueSelect.addEventListener("change", loadPage);

    loadPage();

    async function loadPage() {
      const date = dateInput.value.replaceAll("-", "_");
      const league = leagueSelect.value;

      document.getElementById("status").textContent = "Loading...";
      document.getElementById("games").innerHTML = "";

      try {

        let filePaths = [];

        if (league === "NHL") {
          filePaths = [
            `win/hockey/04_select/${date}_NHL.csv`
          ];
        }

        if (league === "NBA") {
          filePaths = [
            `win/basketball/04_select/${date}_basketball_NBA_moneyline.csv`,
            `win/basketball/04_select/${date}_basketball_NBA_spread.csv`,
            `win/basketball/04_select/${date}_basketball_NBA_total.csv`
          ];
        }

        if (league === "NCAAB") {
          filePaths = [
            `win/basketball/04_select/${date}_basketball_NCAAB_moneyline.csv`,
            `win/basketball/04_select/${date}_basketball_NCAAB_spread.csv`,
            `win/basketball/04_select/${date}_basketball_NCAAB_total.csv`
          ];
        }

        const responses = await Promise.all(
          filePaths.map(path =>
            fetch(path).then(res => {
              if (!res.ok) return null;
              return res.text();
            })
          )
        );

        let combinedRows = [];

        responses.forEach(csv => {
          if (!csv) return;
          const rows = parseTSV(csv);
          combinedRows = combinedRows.concat(rows);
        });

        if (combinedRows.length === 0) {
          throw new Error("No files found");
        }

        // Sort by edge % descending
        combinedRows.sort((a, b) =>
          parseFloat(b.take_bet_edge_pct || 0) -
          parseFloat(a.take_bet_edge_pct || 0)
        );

        renderGames(combinedRows);

        document.getElementById("status").textContent =
          `${combinedRows.length} picks found`;

      } catch (err) {
        document.getElementById("status").textContent =
          "No picks found for selected date/league.";
      }
    }

    function parseTSV(csv) {
      const lines = csv.trim().split(/\r?\n/);
      const headers = lines[0].split("\t");

      return lines.slice(1).map(line => {
        const values = line.split("\t");
        const row = {};
        headers.forEach((header, index) => {
          row[header.trim()] = values[index] ?? "";
        });
        return row;
      });
    }

    function renderGames(rows) {
      const container = document.getElementById("games");
      container.innerHTML = "";

      rows.forEach(row => {

        const edgePct = row.take_bet_edge_pct
          ? (parseFloat(row.take_bet_edge_pct) * 100).toFixed(2) + "%"
          : "-";

        const gameDiv = document.createElement("div");
        gameDiv.className = "game-card";

        gameDiv.innerHTML = `
          <div class="game-league">${row.league || leagueSelect.value}</div>
          <div class="game-market">${row.market || "-"}</div>
          <div class="game-line">${row.take_team || "-"}</div>
          <div class="game-odds">Odds: ${row.take_odds || "-"}</div>
          <div class="game-edge">Edge: ${edgePct}</div>
          <div class="game-value">Value: ${row.value || "-"}</div>
        `;

        container.appendChild(gameDiv);
      });
    }
  </script>
</body>
</html>
