<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Top Picks</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="css/terminal.css" />
</head>
<body>
  <div class="container">

    <h1>Top Picks</h1>

    <div id="nav-placeholder"></div>

    <section class="controls">
      <label for="tp-date" class="control-label">Date:</label>
      <input id="tp-date" type="date" />
    </section>

    <div id="status" class="status"></div>
    <div id="games" class="games"></div>

  </div>

  <script src="app.js"></script>

  <script>
    // ===============================
    // Load Shared Nav
    // ===============================
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });

    // ===============================
    // Date Handling
    // ===============================
    const dateInput = document.getElementById("tp-date");
    const now = new Date();
    dateInput.value = now.toLocaleDateString("en-CA");

    dateInput.addEventListener("change", loadPage);
    loadPage();

    // ===============================
    // Main Loader
    // ===============================
    function loadPage() {
      const date = dateInput.value.replaceAll("-", "_");
      const filePath = `win/winners/step_03/winners_${date}.csv`;

      document.getElementById("status").textContent = "Loading...";
      document.getElementById("games").innerHTML = "";

      fetch(filePath)
        .then(res => {
          if (!res.ok) throw new Error("File not found");
          return res.text();
        })
        .then(csv => {
          const rows = parseCSV(csv);
          renderGames(rows);
          document.getElementById("status").textContent = `${rows.length} picks found`;
        })
        .catch(() => {
          document.getElementById("status").textContent = "No picks found for selected date.";
        });
    }

    // ===============================
    // SAFE CSV Parser (Position Based)
    // ===============================
    function parseCSV(csv) {
      const lines = csv.trim().split("\n");

      return lines.slice(1).map(line => {
        const v = line.split(",");

        return {
          date: v[0],
          time: v[1],
          away_team: v[2],
          home_team: v[3],
          league: v[4],
          game_id: v[5],

          home_ml_edge: v[6],
          away_ml_edge: v[7],
          away_ml_odds: v[8],
          home_ml_odds: v[9],

          away_spread: v[10],
          home_spread: v[11],
          home_spread_edge: v[12],
          away_spread_edge: v[13],
          away_spread_odds: v[14],
          home_spread_odds: v[15],

          over_edge: v[16],
          under_edge: v[17],
          over_odds: v[18],
          under_odds: v[19],

          total: v[22],
          bet: v[23]
        };
      });
    }

    // ===============================
    // Render Picks
    // ===============================
    function renderGames(rows) {
      const container = document.getElementById("games");
      container.innerHTML = "";

      rows.forEach(row => {

        const betType = row.bet;
        let market = "";
        let line = "";
        let odds = "";
        let edge = "";

        // Moneyline
        if (betType === "home_ml") {
          market = "Moneyline";
          line = row.home_team;
          odds = row.home_ml_odds;
          edge = row.home_ml_edge;
        }

        if (betType === "away_ml") {
          market = "Moneyline";
          line = row.away_team;
          odds = row.away_ml_odds;
          edge = row.away_ml_edge;
        }

        // Spread
        if (betType === "home_spread") {
          market = "Spread";
          line = `${row.home_team} ${row.home_spread}`;
          odds = row.home_spread_odds;
          edge = row.home_spread_edge;
        }

        if (betType === "away_spread") {
          market = "Spread";
          line = `${row.away_team} ${row.away_spread}`;
          odds = row.away_spread_odds;
          edge = row.away_spread_edge;
        }

        // Totals
        if (betType === "over") {
          market = "Total";
          line = `Over ${row.total}`;
          odds = row.over_odds;
          edge = row.over_edge;
        }

        if (betType === "under") {
          market = "Total";
          line = `Under ${row.total}`;
          odds = row.under_odds;
          edge = row.under_edge;
        }

        const edgeDisplay = edge && !isNaN(edge)
          ? (parseFloat(edge) * 100).toFixed(2) + "%"
          : "-";

        const oddsDisplay = odds && odds !== "" ? odds : "-";

        const gameDiv = document.createElement("div");
        gameDiv.className = "game-card";

        gameDiv.innerHTML = `
          <div class="game-time">${row.time}</div>
          <div class="game-matchup">${row.away_team} @ ${row.home_team}</div>
          <div class="game-league">${row.league}</div>
          <div class="game-market">${market}</div>
          <div class="game-line">${line}</div>
          <div class="game-odds">Odds: ${oddsDisplay}</div>
          <div class="game-edge">Edge: ${edgeDisplay}</div>
        `;

        container.appendChild(gameDiv);
      });
    }

  </script>
</body>
</html>
