name: AUTORUN DK Text to CSV (Mixed Markets)

on:
  workflow_dispatch:
    inputs:
      league:
        required: true
        type: string
      raw_text:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate league
        shell: bash
        run: |
          case "${{ inputs.league }}" in
            nba|ncaab|nhl|nfl|mlb|mls|soc) ;;
            *) echo "invalid league"; exit 1 ;;
          esac

      - name: Write raw text
        shell: bash
        env:
          RAW_TEXT: ${{ inputs.raw_text }}
        run: |
          printf '%s\n' "$RAW_TEXT" > raw.txt

      - name: Parse DK text (all markets)
        shell: bash
        env:
          LEAGUE: ${{ inputs.league }}
        run: |
          set +e
          python3 scripts/dk_text_to_csv.py "$LEAGUE"
          echo "SCRIPT_EXIT_CODE=$?" >> $GITHUB_ENV
          set -e

      - name: Inspect outputs
        shell: bash
        run: |
          echo "=== manual/first ==="
          ls -lah docs/win/manual/first || true
          echo "=== dk_input logs ==="
          ls -lah docs/win/errors/dk_input || true

      - name: Commit CSVs + logs
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/win/manual/first/*.csv || true
          git add docs/win/errors/dk_input/*.txt || true

          git diff --cached --quiet || git commit -m "Add DK CSVs + input log (${{ inputs.league }})"
          git push

      - name: Fail if parser failed
        shell: bash
        run: |
          if [ "$SCRIPT_EXIT_CODE" != "0" ]; then
            echo "DK input parser failed"
            exit 1
          fi
