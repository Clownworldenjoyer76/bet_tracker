name: DK Text to CSV

on:
  workflow_dispatch:
    inputs:
      league:
        required: true
        type: string
      raw_text:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate league
        run: |
          case "${{ inputs.league }}" in
            nba|ncaab|nhl|soc) ;;
            *) echo "invalid league"; exit 1 ;;
          esac

      - name: Write input
        run: |
          mkdir -p docs/win/manual
          cat <<EOF > raw.txt
${{ inputs.raw_text }}
EOF

      - name: Parse DK text
        run: |
          python3 <<'EOF'
          import csv
          from datetime import datetime

          league = "${{ inputs.league }}"
          out = f"docs/win/manual/dk_{league}_{datetime.now().strftime('%Y_%m_%d')}.csv"

          with open("raw.txt") as f:
              lines = [l.strip().replace("opens in a new tab","") for l in f if l.strip()]

          rows = []
          i = 0

          while i < len(lines):
              if "@" not in lines[i]:
                  i += 1
                  continue

              away, home = [x.strip() for x in lines[i].split("@")]
              date, time = [x.strip() for x in lines[i+1].split(",")]
              i += 6  # header labels

              t1, o1, h1, b1 = lines[i:i+4]
              t2, o2, h2, b2 = lines[i+4:i+8]

              rows.append([date, time, t1, away, o1, h1[:-1], b1[:-1], league])
              rows.append([date, time, t2, home, o2, h2[:-1], b2[:-1], league])

              i += 8

          with open(out, "w", newline="") as f:
              w = csv.writer(f)
              w.writerow(["date","time","team","opponent","odds","handle_pct","bets_pct","league"])
              w.writerows(rows)
          EOF

      - name: Commit
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/win/manual/*.csv
          git commit -m "Add DK CSV" || true
          git push
