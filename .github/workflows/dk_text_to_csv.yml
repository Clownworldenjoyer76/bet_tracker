name: DK Text to CSV

on:
  workflow_dispatch:
    inputs:
      league:
        description: "league (nba | ncaab | nhl | soc)"
        required: true
      raw_text:
        description: "Raw DraftKings text block"
        required: true
      run_id:
        description: "Frontend run identifier"
        required: false

jobs:
  build_csv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate league
        run: |
          case "${{ inputs.league }}" in
            nba|ncaab|nhl|soc) ;;
            *)
              echo "Invalid league: ${{ inputs.league }}"
              exit 1
              ;;
          esac

      - name: Write raw text to file
        run: |
          cat << 'EOF' > raw.txt
${{ inputs.raw_text }}
EOF

      - name: Parse DK text and build CSV
        run: |
          python3 << 'EOF'
          import csv
          from datetime import datetime

          LEAGUE = "${{ inputs.league }}"
          OUT = f"docs/win/manual/dk_{LEAGUE}_{datetime.now().strftime('%Y_%m_%d')}.csv"

          with open("raw.txt") as f:
              raw_lines = [l.strip() for l in f if l.strip()]

          # normalize noise
          lines = [l.replace("opens in a new tab", "").strip() for l in raw_lines]

          rows = []
          i = 0

          while i < len(lines):
              # game header
              if "@" not in lines[i]:
                  i += 1
                  continue

              away, home = [x.strip() for x in lines[i].split("@")]
              date_str, time_str = [x.strip() for x in lines[i + 1].split(",")]

              i += 2

              # labeled section (do not skip blindly)
              if lines[i] != "Moneyline":
                  raise ValueError(f"Expected 'Moneyline', got '{lines[i]}'")
              i += 1

              if lines[i] != "Odds":
                  raise ValueError(f"Expected 'Odds', got '{lines[i]}'")
              i += 1

              if lines[i] != "% Handle":
                  raise ValueError(f"Expected '% Handle', got '{lines[i]}'")
              i += 1

              if lines[i] != "% Bets":
                  raise ValueError(f"Expected '% Bets', got '{lines[i]}'")
              i += 1

              # team 1 (DK lists HOME team first)
              team1 = lines[i]; i += 1
              odds1 = lines[i]; i += 1
              handle1 = lines[i].replace("%", ""); i += 1
              bets1 = lines[i].replace("%", ""); i += 1

              # team 2
              team2 = lines[i]; i += 1
              odds2 = lines[i]; i += 1
              handle2 = lines[i].replace("%", ""); i += 1
              bets2 = lines[i].replace("%", ""); i += 1

              rows.append([
                  date_str,
                  time_str,
                  team1,
                  away,
                  odds1,
                  handle1,
                  bets1,
                  LEAGUE
              ])

              rows.append([
                  date_str,
                  time_str,
                  team2,
                  home,
                  odds2,
                  handle2,
                  bets2,
                  LEAGUE
              ])

          with open(OUT, "w", newline="") as f:
              writer = csv.writer(f)
              writer.writerow([
                  "date",
                  "time",
                  "team",
                  "opponent",
                  "odds",
                  "handle_pct",
                  "bets_pct",
                  "league"
              ])
              writer.writerows(rows)

          print(f"Wrote {len(rows)} rows to {OUT}")
          EOF

      - name: Commit CSV
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/win/manual/*.csv
          git commit -m "Add DK manual CSV (${{ inputs.league }}) ${{ inputs.run_id }}" || echo "Nothing to commit"
          git push
