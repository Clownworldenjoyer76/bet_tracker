name: 09 AUTORUN DK_01 Text to CSV

on:
  workflow_dispatch:
    inputs:
      league:
        required: true
        type: string
      market:
        required: true
        type: string
      raw_text:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate league
        shell: bash
        run: |
          case "${{ inputs.league }}" in
            nba|ncaab|nhl|nfl|soc|mls|mlb) ;;
            *) echo "invalid league"; exit 1 ;;
          esac

      - name: Validate market
        shell: bash
        run: |
          case "${{ inputs.market }}" in
            spreads) ;;
            *) echo "invalid market"; exit 1 ;;
          esac

      - name: Write raw text
        shell: bash
        env:
          RAW_TEXT: ${{ inputs.raw_text }}
        run: |
          mkdir -p docs/win/manual
          printf '%s\n' "$RAW_TEXT" > raw.txt

      - name: Parse DK spreads
        shell: bash
        env:
          LEAGUE: ${{ inputs.league }}
        run: |
          python3 <<'PY'
          import csv, os
          from datetime import datetime

          league = os.environ["LEAGUE"]
          league_col = f"{league}_spreads"
          date = datetime.now().strftime("%Y_%m_%d")
          out = f"docs/win/manual/dk_{league}_spreads_{date}.csv"

          with open("raw.txt") as f:
              lines = [l.replace("opens in a new tab","").strip() for l in f if l.strip()]

          rows = []
          i = 0

          while i < len(lines):
              if "@" not in lines[i]:
                  i += 1
                  continue

              away, home = [x.strip() for x in lines[i].split("@", 1)]
              date_str, time_str = [x.strip() for x in lines[i+1].split(",", 1)]

              # advance past matchup + datetime
              i += 2

              # enforce header
              if lines[i:i+4] != ["Spread","Odds","% Handle","% Bets"]:
                  raise SystemExit(f"spread header mismatch at line {i}")

              i += 4

              # team 1
              t1_raw = lines[i]
              o1 = lines[i+1]
              h1 = lines[i+2].rstrip("%")
              b1 = lines[i+3].rstrip("%")

              # team 2
              t2_raw = lines[i+4]
              o2 = lines[i+5]
              h2 = lines[i+6].rstrip("%")
              b2 = lines[i+7].rstrip("%")

              i += 8  # <-- THIS WAS YOUR BUG BEFORE

              team1, spread1 = t1_raw.rsplit(" ", 1)
              team2, spread2 = t2_raw.rsplit(" ", 1)

              rows.append([date_str, time_str, team1, home if team1 == home else away, spread1, o1, h1, b1, league_col])
              rows.append([date_str, time_str, team2, away if team2 == away else home, spread2, o2, h2, b2, league_col])

          with open(out, "w", newline="") as f:
              w = csv.writer(f)
              w.writerow(["date","time","team","opponent","spread","odds","handle_pct","bets_pct","league"])
              w.writerows(rows)
          PY

      - name: Commit CSV
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/win/manual/*.csv
          git commit -m "Fix DK spreads parsing" || true
          git push
