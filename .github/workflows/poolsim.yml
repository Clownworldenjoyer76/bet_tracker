name: 2000-Player Pool Simulation

on:
  workflow_dispatch:
    inputs:
      opponent_model:
        description: "Opponent pick model"
        required: true
        default: "uniform"
        type: choice
        options:
          - uniform
          - ev_biased
          - tier_biased
      players:
        description: "Total players in pool"
        required: true
        default: "2000"
      olympics:
        description: "Number of simulated Olympics"
        required: true
        default: "50000"
      lineup:
        description: "Comma-separated 6-country lineup"
        required: true
        default: "Germany,Norway,USA,Canada,Kazakhstan,Croatia"

jobs:
  simulate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas

      - name: Ensure output directory exists
        run: |
          mkdir -p testing/olympics

      - name: Run simulation and write CSV to repo
        run: |
          OUTPUT=$(python scripts/simulate_pool_winprob.py \
            --opponent_model "${{ github.event.inputs.opponent_model }}" \
            --players "${{ github.event.inputs.players }}" \
            --olympics "${{ github.event.inputs.olympics }}" \
            --lineup "${{ github.event.inputs.lineup }}")

          PLAYERS=$(echo "$OUTPUT" | grep "Players:" | awk '{print $2}')
          OLYMPICS=$(echo "$OUTPUT" | grep "Olympics simulated:" | awk '{print $3}')
          MODEL=$(echo "$OUTPUT" | grep "Opponent model:" | awk '{print $3}')
          LINEUP=$(echo "$OUTPUT" | grep "My lineup:" | cut -d':' -f2 | xargs | tr ' ' ',')
          STRICT=$(echo "$OUTPUT" | grep "Strict win probability:" | awk '{print $4}')
          SHARE=$(echo "$OUTPUT" | grep "Expected win share" | awk '{print $6}')

          CSV=testing/olympics/pool_sim_results.csv

          if [ ! -f "$CSV" ]; then
            echo "players,olympics,opponent_model,lineup,strict_win_probability,expected_win_share" > "$CSV"
          fi

          echo "$PLAYERS,$OLYMPICS,$MODEL,\"$LINEUP\",$STRICT,$SHARE" >> "$CSV"

      - name: Commit CSV to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add testing/olympics/pool_sim_results.csv
          git commit -m "Add pool simulation result"
          git push

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: pool-simulation-csv
          path: testing/olympics/pool_sim_results.csv
