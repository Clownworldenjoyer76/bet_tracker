name: 03 DK Identity + Validation

on:
  workflow_dispatch:

jobs:
  dk_identity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      # =========================
      # DK 03 — attach game_id
      # =========================
      - name: DK 03 – normalize by games_master
        run: python scripts/dk_03.py

      # =========================
      # Validate games_master
      # =========================
      - name: Validate games_master (cleaned + normalized)
        run: |
          set +e
          python scripts/validate_games_master.py \
            docs/win/dump/csvs/cleaned \
            docs/win/manual/normalized
          echo "VALIDATION_EXIT_CODE=$?" >> $GITHUB_ENV
          set -e
      # =========================
      # Print Validate games_master LOG
      # =========================
      - name: Print validation log
        if: always()
        run: |
          echo "==== VALIDATION TXT ===="
          cat docs/win/errors/03_dk_iv/games_master_validation.txt || true
          echo ""
          echo "==== VALIDATION CSV ===="
          cat docs/win/errors/03_dk_iv/games_master_validation_errors.csv || true

      # =========================
      # Stop immediately if validation failed
      # =========================
      - name: Fail if validation failed
        run: |
          if [ "$VALIDATION_EXIT_CODE" != "0" ]; then
            echo "Games master validation failed"
            exit 1
          fi

      # =========================
      # DK 04 — inject handle/bets %
      # =========================
      - name: DK 04 – inject handle/bets percentages
        run: python scripts/dk_04.py

      # =========================
      # DK 05 — inject spread columns
      # =========================
      - name: DK 05 – inject spread columns
        run: python scripts/dk_05.py

      # =========================
      # Commit outputs + logs
      # =========================
      - name: Commit normalized data and logs
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add docs/win/manual/normalized
          git add docs/win/errors/03_dk_iv/

          git status

          git commit -m "DK 03 attach game_id + validation + DK 04 inject handle/bets % + DK 05 inject spreads" || echo "No changes to commit"
          git push
